--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

PsychoZedMod = PsychoZedMod or {}

-----------------------               ---------------------------


function PsychoZedMod.getAbsorbDmgChance()
	local chance = SandboxVars.PsychoZed.AbsorbDmgChance
	if chance == 0 then return false  end
	if chance == 100 then return true end
	return PsychoZedMod.doRoll(chance)
end

function PsychoZedMod.hitZ(zed, pl, bodyPartType, wpn)
	if not zed or not PsychoZedMod.isPsychoZed(zed)  then return end
	--PsychoZedMod.setSympathy(zed, PsychoZedMod.shouldSympathize(zed))


	if PsychoZedMod.getAbsorbDmgChance() then
		zed:setAvoidDamage(true)
	else
		zed:setAvoidDamage(false)
	end

	if PsychoZedMod.shouldSympathize(zed) then
		zed:setAvoidDamage(true)
		zed:setShootable(false)
	end
	if PsychoZedMod.isShouldStand(zed) then
		PsychoZedMod.setStand(zed)
	end


end
Events.OnHitZombie.Remove(PsychoZedMod.hitZ)
--Events.OnHitZombie.Add(PsychoZedMod.hitZ)




function PsychoZedMod.DropRoll(pl)
	local DropHandItemChance = SandboxVars.PsychoZed.DropHandItemChance
	if DropHandItemChance == 0 then return false end
	return PsychoZedMod.doRoll(DropHandItemChance)
end

function PsychoZedMod.doDrop(pl)
	local pr = pl:getPrimaryHandItem()
	if not pr then return end
	if tostring(WeaponType.getWeaponType(pl)) == 'barehand' or  pr:getCategories():contains("Unarmed") then return end
	pl:fallenOnKnees()
end


function PsychoZedMod.lacerateRoll(pl)
	local LacerateChance = SandboxVars.PsychoZed.LacerateChance
	if LacerateChance == 0 then return false end
	return PsychoZedMod.doRoll(LacerateChance)
end


function PsychoZedMod.getRandPart(pl)
	return pl:getBodyDamage():getBodyPart(BodyPartType.FromIndex(ZombRand(BodyPartType.ToIndex(BodyPartType.MAX))));
end


function PsychoZedMod.doPain(pl)
	local part = PsychoZedMod.getPart(pl)
	local PsychoZedPain = part:getAdditionalPain()
	if PsychoZedPain > 0 then
		local max = 101-PsychoZedPain
		local roll = PsychoZedPain + ZombRand(1, max)
		part:setAdditionalPain(roll)
	else
		part:setAdditionalPain(ZombRand(1, 101))
	end
end


function PsychoZedMod.getPart(pl)
	local bdDmg = pl:getBodyDamage()
	local parts = {
		[1]=bdDmg:getBodyPart(BodyPartType.Torso_Upper),
		[2]=bdDmg:getBodyPart(BodyPartType.ForeArm_L),
		[3]=bdDmg:getBodyPart(BodyPartType.ForeArm_R),
		[4]=bdDmg:getBodyPart(BodyPartType.UpperArm_L),
		[5]=bdDmg:getBodyPart(BodyPartType.UpperArm_R),
		[6]=bdDmg:getBodyPart(BodyPartType.Neck),
		[7]=bdDmg:getBodyPart(BodyPartType.Back),
		[8]=bdDmg:getBodyPart(BodyPartType.Head),
	}
	return parts[ZombRand(1,9)]
end

function PsychoZedMod.LacerateRoll(pl)
	local LacerateChance = SandboxVars.PsychoZed.LacerateChance
	if LacerateChance == 0 then return false end
	return PsychoZedMod.doRoll(LacerateChance)
end

function PsychoZedMod.doPsychoZedDmg(pl)
	local minDmg = SandboxVars.PsychoZed.MinDmg
	local maxDmg = SandboxVars.PsychoZed.MaxDmg
	local part = PsychoZedMod.getPart(pl)
	part:AddDamage(ZombRand(minDmg, maxDmg+1))
end



function PsychoZedMod.doLacerate(targ)
	if instanceof(targ, "IsoZombie") then
		if not targ:isOnFloor() then
			targ:knockDown(true)
			targ:setKnockedDown(true)
		end
	elseif instanceof(targ, "IsoPlayer") then
		local part = PsychoZedMod.getRandPart(targ)
		if PsychoZedMod.doRoll(50) then
			local dmgTime = part:getCutTime()
			if dmgTime > 0 then
				local max = 101-dmgTime
				local roll = dmgTime + ZombRand(1, max)
				part:setCutTime(roll)
			end
			part:setCut(true);
		else
			local dmgTime = part:getScratchTime()
			if dmgTime > 0 then
				local max = 101-dmgTime
				local roll = dmgTime + ZombRand(1, max)
				part:setScratchTime(roll)
			end
			part:setScratched(true, false);
		end
	end
end



function PsychoZedMod.onPlayerHit(pl, targ, wpn, dmg)
    if not pl or not targ then return end
    if not instanceof(pl, "IsoPlayer") or not instanceof(targ, "IsoPlayer") then return end
    if targ:isDead() then return end
	if (PsychoZedMod.isWearingPsychoZed(pl) or pl:getVariableBoolean('isWearingPsychoZed') == true)  then
		if targ == getPlayer() then
			PsychoZedMod.attackOutput(targ)
		elseif pl == getPlayer() then
			local bd = targ:getBodyDamageRemote()
			if not bd then return end
			local hp = bd:getOverallBodyHealth()
			if hp then
				targ:addLineChatElement(tostring(hp))		
			end
		end
	end
end
Events.OnWeaponHitCharacter.Add(PsychoZedMod.onPlayerHit)



function PsychoZedMod.attackOutput(pl)
	if PsychoZedMod.LacerateRoll(pl) then
		PsychoZedMod.doLacerate(pl)
	end
	if PsychoZedMod.doRoll(50) then
		PsychoZedMod.doPsychoZedDmg(pl)
	else
		PsychoZedMod.doPain(pl)
	end
	if PsychoZedMod.DropRoll(pl) then
		PsychoZedMod.doDrop(pl)
	end
end
--[[ 
function PsychoZedMod.hit(zed, pl, wpn, HP)
	if not zed then return end
	if not instanceof(zed, 'IsoZombie') then return end
	if PsychoZedMod.isPsychoZed(zed) and pl == getPlayer() then
		if zed:isCriticalHit() then
			if PsychoZedMod.doRoll(SandboxVars.PsychoZed.InstaKillChance) then
				pl:Kill(pl)
				return
			else
				PsychoZedMod.attackOutput(pl)
			end
		end
		PsychoZedMod.attackOutput(pl)
	end
end
Events.OnWeaponHitCharacter.Remove(PsychoZedMod.hit)
Events.OnWeaponHitCharacter.Add(PsychoZedMod.hit)

 ]]