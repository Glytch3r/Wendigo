--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


PsychoZedMod = PsychoZedMod or {}
local Commands = {};
Commands.PsychoZed = {};


PsychoZedMod.skin1 = 'PsychoZedMod.Psycho1'
PsychoZedMod.skin2 = 'PsychoZedMod.Psycho2'
-----------------------            ---------------------------
function PsychoZedMod.getTargetedZombie(pl)
    local zombies = getCell():getZombieList()
    local targetedZombie = nil
    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
		if PsychoZedMod.isTarg(pl, zed) then
            targetedZombie = zed
            break
        end
    end

    return targetedZombie
end

function PsychoZedMod.getDistanceBetween(pl, zed)
    local plX, plY = pl:getX(), pl:getY()
    local zedX, zedY = zed:getX(), zed:getY()
    return math.sqrt((plX - zedX) ^ 2 + (plY - zedY) ^ 2)
end

function PsychoZedMod.getFov()
    return SandboxVars.PsychoZed.FOV or 50
end

function PsychoZedMod.isTarg(pl, targ)
	local fov = PsychoZedMod.getFov()
    local plX, plY = pl:getX(), pl:getY()
    local targX, targY = targ:getX(), targ:getY()

    local targDirX = targX - plX
    local targDirY = targY - plY

	--print(pl:getDotWithForwardDirection(targ:getX(), targ:getY()))
	--local fVec = pl:getForwardDirection()

	 local aimAngle = pl:getLookAngleRadians()

	--local angle = pl:getDirectionAngle()
    local angle = math.atan2(targDirY, targDirX)

    local angleDiff = math.abs(aimAngle - angle)


    if angleDiff > math.pi then
        angleDiff = 2 * math.pi - angleDiff
    end

    local fovInRadians = math.rad(fov) / 2

	--print(angleDiff)
	--print(fovInRadians)

	--print(angle)

    return angleDiff <= fovInRadians
end

------------------------    pl*           ----------

--	local num = PsychoZedMod.getDayTimeInt()
-----------------------    wear*        ---------------------------
function PsychoZedMod.wearPsychoZed(pl, int)
	if not (getCore():getDebug() or isAdmin()) then return end
	PsychoZedMod.clearPsychoZedSkin(pl)
	local item = InventoryItemFactory.CreateItem(PsychoZedMod.skin1)
	if not int then
		int = ZombRand(1,3)
	end
	if int == 2 then
		item = InventoryItemFactory.CreateItem(PsychoZedMod.skin2)
	end
	local inv = pl:getInventory()
	local equip = inv:addItem(item);
	pl:setWornItem(equip:getBodyLocation(), equip);
	--PsychoZedMod.setTag(pl, int)
	--if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
	triggerEvent("OnClothingUpdated", pl)
	pl:resetModelNextFrame();
end

-----------------------            ---------------------------
-----------------------       ---------------------------
function PsychoZedMod.clearPsychoZedSkin(pl)
	local inv = pl:getInventory()
	for i = inv:getItems():size(), 1, -1 do
		local item = inv:getItems():get(i-1)
		if item and (item:getFullType() == PsychoZedMod.skin1  or item:getFullType() == PsychoZedMod.skin2) then
			pl:removeWornItem(item)
			inv:DoRemoveItem(item)
		end
	end
	PsychoZedMod.removeTag(pl)
	pl:setHideWeaponModel(false)
	pl:clearWornItems();
	pl:resetModelNextFrame();
end
-----------------------            ---------------------------


function PsychoZedMod.wpnHide(pl, wpn)
	if PsychoZedMod.isWearingPsychoZed(pl) then
		pl:setHideWeaponModel(true)
	else
		pl:setHideWeaponModel(false)
	end
end
--Events.OnEquipPrimary.Add(PsychoZedMod.wpnHide)
--Events.OnEquipSecondary.Add(PsychoZedMod.wpnHide)
-----------------------            ---------------------------
function PsychoZedMod.getAdminSkinNum(pl)
	if not pl then return end
	if not instanceof(pl, "IsoPlayer") then return false end
	if not PsychoZedMod.isWearingPsychoZed(pl) then return end
	local wornItems = pl:getWornItems()
	if wornItems then
		for i=1, wornItems:size() do
			local item = wornItems:get(i-1):getItem()
			if item:getFullType() == PsychoZedMod.skin1 then
				return 1
			elseif  item:getFullType() == PsychoZedMod.skin2 then
				return 2
			end
		end
	end
	return nil
end

function PsychoZedMod.isWearingPsychoZed(pl)
	if not pl then return false end
	if not instanceof(pl, "IsoPlayer") then return false end
	local wornItems = pl:getWornItems()
	if wornItems then
		for i=1, wornItems:size() do
			local item = wornItems:get(i-1):getItem()
			if item:getFullType() == PsychoZedMod.skin1 or item:getFullType() == PsychoZedMod.skin2 then
				return true
			end
		end
	end
	return false
end
-----------------------            ---------------------------
function PsychoZedMod.isUnarmed(pl, wpn)
	return (tostring(WeaponType.getWeaponType(pl)) == 'barehand' or (wpn and wpn:getCategories():contains("Unarmed"))) or wpn == nil
end

-----------------------            ---------------------------

function PsychoZedMod.AdminPsychoZed()
	local pl = getPlayer() 
	if not pl then return end 
	if PsychoZedMod.isWearingPsychoZed(pl) and string.lower(pl:getAccessLevel()) == "admin" then
		if pl:getVariableBoolean('isWearingPsychoZed') == false then
			pl:setVariable('isWearingPsychoZed', 'true')
			--if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
			if isClient() then
				sendClientCommand('PsychoZed', 'isWearingPsychoZed', {isWearingPsychoZed = true})
			end
		end
	else
		if pl:getVariableBoolean('isWearingPsychoZed') == true then
			pl:setVariable('isWearingPsychoZed', 'false');

			--if pl:isHideWeaponModel() then pl:setHideWeaponModel(false) end
			if isClient() then
				sendClientCommand('PsychoZed', 'isWearingPsychoZed', {isWearingPsychoZed = false})
			end
		end
	end
end
Events.OnWeaponSwing.Add(PsychoZedMod.AdminPsychoZed)
Events.EveryTenMinutes.Add(PsychoZedMod.AdminPsychoZed)
Events.OnClothingUpdated.Add(PsychoZedMod.AdminPsychoZed)
Events.OnScoreboardUpdate.Add(PsychoZedMod.AdminPsychoZed)




--[[ 
Events.OnPlayerUpdate.Remove(PsychoZedMod.AdminPsychoZed)
Events.OnPlayerUpdate.Add(PsychoZedMod.AdminPsychoZed)
 ]]

--[[
function PsychoZedMod.AimHandler(pl)

	if pl:isAimKeyDown() then
		local zed = PsychoZedMod.getTargetedZombie(pl)
		if zed then
			if PsychoZedMod.isCrying(zed) and PsychoZedMod.isPsychoZed(zed) then
				if SandboxVars.PsychoZed.PlayerSympathy then
					if zed:isShootable() then
						zed:setShootable(false)
						--print(zed:isShootable())
					end
					pl:setIgnoreAimingInput(true)
					pl:nullifyAiming()
				end
			end
		end
	else
		pl:setIgnoreAimingInput(false)
	end
end
Events.OnPlayerUpdate.Remove(PsychoZedMod.AimHandler)
Events.OnPlayerUpdate.Add(PsychoZedMod.AimHandler)

 ]]

--[[

function PsychoZedMod.OnKeyKeepPressed(key)
	local pl = getPlayer()
	if key == getCore():getKey("Aim") then
		print(getCore():getKey("Aim"))
		getPlayer():setHaloNote(tostring('test'),150,250,150,900)
		local zed = PsychoZedMod.getTargetedZombie(pl)
		if zed then
			if PsychoZedMod.isPsychoZed(zed) then
				pl:nullifyAiming()
			else

			end
		else

		end
	end
	return key
end
Events.OnKeyKeepPressed.Remove(PsychoZedMod.OnKeyKeepPressed)
Events.OnKeyKeepPressed.Add(PsychoZedMod.OnKeyKeepPressed)


 ]]
function PsychoZedMod.OnLoad()
	local pl = getPlayer(); if not pl then return end
	pl:setIgnoreAimingInput(false)
	if not PsychoZedMod.isWearingPsychoZed(pl) then
		pl:setHideWeaponModel(false)
	end
end
Events.OnLoad.Add(PsychoZedMod.OnLoad)